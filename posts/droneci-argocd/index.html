<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link rel=stylesheet href=https://unpkg.com/spectre.css/dist/spectre.min.css><link rel=stylesheet href=https://unpkg.com/spectre.css/dist/spectre-exp.min.css><link rel=stylesheet href=https://unpkg.com/spectre.css/dist/spectre-icons.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/nnfx-dark.min.css><link rel=stylesheet href=https://pro.fontawesome.com/releases/v5.10.0/css/all.css integrity=sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p crossorigin=anonymous><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.81.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>使用 DroneCI 與 ArgoCD 實現 K8s 自動整合部署 &#183; Ming's Site</title><meta name=description content><link type=text/css rel=stylesheet href=https://minghsu0107.github.io/css/print.css media=print><link type=text/css rel=stylesheet href=https://minghsu0107.github.io/css/poole.css><link type=text/css rel=stylesheet href=https://minghsu0107.github.io/css/syntax.css><link type=text/css rel=stylesheet href=https://minghsu0107.github.io/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><style>pre,code{white-space:pre;overflow-x:scroll}.hljs{display:inline-block;overflow-x:scroll;padding-right:100%;background:0 0;color:#fff;-webkit-text-size-adjust:none;min-width:2300px}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-96ZZVQWZLF"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-96ZZVQWZLF')</script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/languages/yaml.min.js></script><script>hljs.initHighlightingOnLoad()</script><body><aside class=sidebar><div class=container><div class=sidebar-about><a href=https://minghsu0107.github.io/><h1>Ming's Site</h1></a><p class=lead><a href=https://github.com/minghsu0107><i class="fab fa-github"></i></a>&nbsp;&nbsp;<a href=https://linkedin.com/in/hao-ming-hsu-178176181> <i class="fab fa-linkedin"></i></a><br><a href=/about>Hao-Ming Hsu (許浩鳴)</a><br>Learn by Doing.<br><a href=https://github.com/minghsu0107>@minghsu0107</a></p></div><nav><ul class=sidebar-nav><li><a href=/about>About</a></li><li><a href=/categories>Categories</a></li><li><a href=/tags>Tags</a></li></ul></nav><p>&copy; 2021. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>使用 DroneCI 與 ArgoCD 實現 K8s 自動整合部署</h1><time datetime=2021-02-25T10:57:02+0800 class=post-date>Thu, Feb 25, 2021 &#183; <span class=read-time>6 min read</span></time><p>這個教學使用 DroneCI 與 ArgoCD 打造 cloud-native 的持續整合交付平台，讓我們在 push commit 或 merge PR 後即可自動跑完測試、打包 image 並部署到 K8s 叢集。必且藉由版控，我們也得以輕鬆 rollback 到之前的任一版本！</p><p><img src=https://i.imgur.com/FygPEyK.png alt></p><p><a href=https://github.com/minghsu0107/cicd-demo>Source code</a></p><h2 id=droneci-介紹>DroneCI 介紹</h2><p>DroneCI 是一個 cloud-native 的 CI (Continuous Integration) 工具。它很好的整合了 Github、Gitlab 與 Bitbucket 等多種程式碼托管平台，讓我們可以直接同步 repository 到 Drone 上。如同 TravisCI 與其他的 CI 工具一樣，我們可以用一個 yaml 檔描述我們的 pipeline (比如 <code>.drone.yml</code>)，而 Drone 在偵測到程式碼異動後就會觸發 webhook 去執行它。</p><p>舉例來說，以下的 <code>.drone.yml</code> 描述了如何跑一個 Golang 應用的測試並發布到 Dockerhub 上：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>pipeline</span>

<span style=color:#f92672>steps</span>:
- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>test</span>
  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>golang</span>
  <span style=color:#f92672>commands</span>:
  - <span style=color:#ae81ff>go test</span>
  - <span style=color:#ae81ff>go build</span>

- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>publish</span>
  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>plugins/docker</span>
  <span style=color:#f92672>settings</span>:
    <span style=color:#f92672>repo</span>: <span style=color:#ae81ff>octocat/hello-world</span>
    <span style=color:#f92672>tags</span>: [ <span style=color:#ae81ff>latest, 1.0, 1 ]</span>
</code></pre></div><p>Drone 特別的是它的每個 pipeline step 都是一個 container，因此我們可以很大程度的客製化符合自身需求的 pipeline，或是可以很簡單的就啟動測試用的外部服務。而 Drone 官方也提供許多實用的 plugins 供我們使用，比如 <a href=http://plugins.drone.io/drone-plugins/drone-docker/>drone-docker</a> 可以用來打包 image，而 <a href=http://plugins.drone.io/drone-plugins/drone-slack/>drone-slack</a> 可以讓我們輕鬆結合 Slack notification。有興趣的話也可以貢獻自己的 plugins，比如這個 Drone 的 <a href=http://plugins.drone.io>Plugin Registry</a> 彙整了眾多社群提供的 Plugins。</p><h2 id=argocd-介紹>ArgoCD 介紹</h2><p>ArgoCD 幫助我們同步 Git 上的 manitests 與 K8s 叢集資源的狀態。也就是說，我們只需要在版控上維護系統的部署狀態 (如 image 的版本、資源限制的設定等)，ArgoCD 就會自動幫我們同步到機器上，並且確認服務是否健康。另外，我們也可以善用大家最熟悉的版控來管理服務，因此 rollback 到任一版本都是非常容易的。</p><p><img src=https://argoproj.github.io/argo-cd/assets/argocd-ui.gif alt></p><p>而這樣管理 K8s 叢集與應用程式交付的方式就叫做 <strong>GitOps</strong>。GitOps 讓我們可以維護服務部署狀態的 &ldquo;source of truth&rdquo;，進而提升團隊維護的效率與系統的可靠性。</p><h2 id=overview>Overview</h2><p><img src=https://i.imgur.com/FygPEyK.png alt></p><ol><li>使用者 push 程式碼或是 merge 新的 PR</li><li>觸發 webhook，Drone 開始執行定義在 <code>.drone.yml</code> 的 CI pipeline</li><li>若測試通過就發布新的 image 到 Dockerhub 上，並更新 manitests repository 上的 image 版本</li><li>ArgoCD 偵測到 manifests 的變動，因此通知 K8s 更新 image 並同步部署狀態</li></ol><h2 id=事先準備>事先準備</h2><p>Source code 可以看 <a href=https://github.com/minghsu0107/cicd-demo>這裡</a>。</p><ol><li>一個 Drone server<ul><li><a href=https://docs.drone.io/server/provider/github/>Github installation</a></li></ul></li><li>一個測試用 K8s 叢集<ul><li><a href=https://k3d.io>K3d</a></li><li><a href=https://minikube.sigs.k8s.io/docs/start/>minikube</a></li><li><a href=https://github.com/k0sproject/k0s>K0s</a></li></ul></li><li>部署 ArgoCD 到叢集上<ul><li><a href=https://argo-cd.readthedocs.io/en/stable/getting_started/#1-install-argo-cd>All-in-one installation</a></li></ul></li><li>一個 Github 帳號與一個 Dockerhub 帳號</li></ol><h2 id=droneci>DroneCI</h2><h3 id=setup>Setup</h3><p>當你成功的在 Drone 上連動 Github 帳號後，你可以在 Drone 的 dashboard 上看到所有的 repo。接著複製這個 repo、activate 它並前往 <code>Repositories -> cicd-demo -> settings</code> 新增以下 secret：</p><p><img src=https://user-images.githubusercontent.com/50090692/111301242-f04c2e80-868c-11eb-9945-c2de30b0ee92.png alt></p><ul><li><code>docker_username</code>: 你的 Dockerhub 帳號</li><li><code>docker_password</code>: 你的 Dockerhub 密碼</li><li><code>ssh_key</code>: Github 的 SSH private key</li></ul><p>最後修改 <code>.drone.yml</code>，把 <code>minghsu0107</code> 替換成你自己的 Github 與 Dockerhub 帳號。現在在 <code>main</code> branch 上的 push 或 pull request 都會觸發 Drone pipeline，有關 Drone 的 Github webhook 的設定可以前往 <code>your repo -> setting -> webhook</code> 查看。</p><h3 id=本機開發>本機開發</h3><p>在本機開發時，我們會想要檢查 <code>.drone.yml</code> 是否撰寫正確但又不想每次都 push 到 repo。此時我們可以使用 <a href=https://docs.drone.io/cli/install/>Drone CLI</a>。它可以讓我們在本機執行 pipeline，並且可以 include 或 exclude 某幾個 step，非常適合用在開發上。</p><p>使用 CLI 登入 Drone:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>export DRONE_SERVER<span style=color:#f92672>=</span>&lt;drone-server-url&gt;
export DRONE_TOKEN<span style=color:#f92672>=</span>&lt;drone-token&gt; <span style=color:#75715e># check token under: dashboard -&gt; user setting</span>
drone info
</code></pre></div><p>舉例來說，我們可以僅執行 <code>test</code> 這個 step：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>drone exec --include<span style=color:#f92672>=</span>&lt;pipline-step-name&gt;
</code></pre></div><h2 id=argocd>ArgoCD</h2><p>開始前請先 clone 這個 <a href=https://github.com/minghsu0107/cicd-demo-manifests>manifest repository</a>。這個 repo 負責所有有關部署應用的 manifests，之後會用來與 ArgoCD 同步。這邊使用 <a href=https://github.com/kubernetes-sigs/kustomize>Kustomize</a> 這個模板工具維護 K8s 的 resources，而且 Kustomize 是被 ArgoCD 原生支援的，這裡就不細談 Kustomize 的使用方法了，只要知道它在這裡幫助我們區分 <code>dev</code> 與 <code>prod</code> 環境，並提高 manifests 的可讀性即可。</p><p>如果你的 repo 是 private 的，你必須要在 ArgoCD 上設定 credentials，否則就可以跳過這個步驟。</p><p>使用 Argo CD CLI:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>argocd repo add &lt;repo-url&gt; --username<span style=color:#f92672>=</span>&lt;username&gt; --password<span style=color:#f92672>=</span>&lt;password&gt;
</code></pre></div><p>也可以使用 GUI：前往 <code>Settings/Repositories</code>、點擊 <code>Connect Repo using HTTPS</code> 並輸入 credentials：</p><p><img src=https://i.imgur.com/UAyNkte.png alt></p><p>你會看到如以下的畫面：</p><p><img src=https://i.imgur.com/XaMezBA.png alt></p><p>新增一個 app：</p><p><img src=https://i.imgur.com/gOD9h1b.png alt></p><p><img src=https://i.imgur.com/8XlNtDL.png alt></p><p><img src=https://i.imgur.com/JK76lnT.png alt></p><p>記得把 repo 替換成你自己的。</p><p>現在我們完成了所有的準備，前往 <code>/applications</code> 並點擊 <code>SYNC</code> 就可以看到 ArgoCD 自動同步了 cluster 的狀態！</p><p><img src=https://i.imgur.com/RVH5QtL.png alt></p><p>也可以點進去 app 看看一些詳細資訊：</p><p><img src=https://i.imgur.com/pconXQR.png alt></p><h2 id=總結>總結</h2><p>DroneCI 與 ArgoCD 都是滿好上手的工具，而且功能也很強大。今後大家若要建置 CI/CD 平台，但又希望自己 host 伺服器而非使用第三方提供的服務 (可能有成本的考量等)，DroneCI 與 ArgoCD 的組合是一個值得考慮的選擇。</p><h2 id=reference>Reference</h2><ul><li><a href=https://www.weave.works/technologies/gitops/>https://www.weave.works/technologies/gitops/</a></li><li><a href=https://argo-cd.readthedocs.io/en/stable/>https://argo-cd.readthedocs.io/en/stable/</a></li><li><a href=https://docs.drone.io>https://docs.drone.io</a></li><li><a href=https://hub.docker.com/r/line/kubectl-kustomize>https://hub.docker.com/r/line/kubectl-kustomize</a></li></ul></div><h2>Comments</h2><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//minghsu0107.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></main></body></html>
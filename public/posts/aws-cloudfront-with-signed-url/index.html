<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link rel=stylesheet href=https://unpkg.com/spectre.css/dist/spectre.min.css><link rel=stylesheet href=https://unpkg.com/spectre.css/dist/spectre-exp.min.css><link rel=stylesheet href=https://unpkg.com/spectre.css/dist/spectre-icons.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/nnfx-dark.min.css><link rel=stylesheet href=https://pro.fontawesome.com/releases/v5.10.0/css/all.css integrity=sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p crossorigin=anonymous><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.81.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>[AWS] AWS CloudFront with Signed URL &#183; Ming's Site</title><meta name=description content="Amazon CloudFront is a fast content delivery network (CDN) service managed by AWS. It serves your contents across edge locations around the globe with high transfer speeds and low latency under secured connections.

In this post, we will set up an Amazon CloudFront distribution that serves private contents on your S3 bucket in order to speed up your content retrival while fully controlling user access permissions."><link type=text/css rel=stylesheet href=https://minghsu0107.github.io/css/print.css media=print><link type=text/css rel=stylesheet href=https://minghsu0107.github.io/css/poole.css><link type=text/css rel=stylesheet href=https://minghsu0107.github.io/css/syntax.css><link type=text/css rel=stylesheet href=https://minghsu0107.github.io/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><style>pre,code{white-space:pre;overflow-x:scroll}.hljs{display:inline-block;overflow-x:scroll;padding-right:100%;background:0 0;color:#fff;-webkit-text-size-adjust:none;min-width:2300px}</style><style>@import "https://fonts.googleapis.com/css?family=Open+Sans";body{font-family:open sans,sans-serif}.searchTerm{border-radius:5px;width:100%;border:1px solid #00b4cc;padding:8px 12px}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-96ZZVQWZLF"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-96ZZVQWZLF')</script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/languages/yaml.min.js></script><script>hljs.initHighlightingOnLoad()</script><body><aside class=sidebar><div class=container><div class=sidebar-about><a href=https://minghsu0107.github.io/><h1>Ming's Site</h1></a><p class=lead><a href=https://github.com/minghsu0107><i class="fab fa-github"></i></a>&nbsp;&nbsp;<a href=https://linkedin.com/in/hao-ming-hsu-178176181> <i class="fab fa-linkedin"></i></a><br><a href=/about>Hao-Ming Hsu (許浩鳴)</a><br>Learn by Doing.<br><a href=https://github.com/minghsu0107>@minghsu0107</a></p></div><nav><ul class=sidebar-nav><li><a href=/about>About</a></li><li><a href=/categories>Categories</a></li><li><a href=/tags>Tags</a></li></ul></nav><div style="margin:0 auto"><form action=https://minghsu0107.github.io/search><input placeholder=search class=searchTerm id=search-query name=s></form></div><br><p>&copy; 2021. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>[AWS] AWS CloudFront with Signed URL</h1><time datetime=2021-05-08T15:27:23+0800 class=post-date>Sat, May 8, 2021 &#183; <span class=read-time>3 min read</span></time><div class=chip><a href=https://minghsu0107.github.io/tags/aws//>AWS</a></div><div class=chip><a href=https://minghsu0107.github.io/tags/s3//>S3</a></div><div class=chip><a href=https://minghsu0107.github.io/tags/cloudfront//>CloudFront</a></div><div class=chip><a href=https://minghsu0107.github.io/tags/golang//>Golang</a></div><br><br><p>Amazon CloudFront is a fast content delivery network (CDN) service managed by AWS. It serves your contents across edge locations around the globe with high transfer speeds and low latency under secured connections.</p><p>In this post, we will set up an Amazon CloudFront distribution that serves private contents on your S3 bucket in order to speed up your content retrival while fully controlling user access permissions.</p><p><img src=https://i.imgur.com/VVroqoy.png alt></p><h2 id=setting-up-cloudfront>Setting up CloudFront</h2><p>First, create a key pair for later use:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>openssl genrsa -out cfprikey.pem <span style=color:#ae81ff>2048</span>
openssl rsa -in cfprikey.pem -outform PEM -pubout -out cfpublic.pem
</code></pre></div><p>Create CloudFront public key using the public key you just created:</p><p><img src=https://i.imgur.com/RT65lEP.png alt></p><p>After the public key is created, it will be given a public key ID. You will need it when signing CloudFront URLs.</p><p>Create a key group that is associated with the CloutFront public key <code>mypublickey</code>:</p><p><img src=https://i.imgur.com/rbPdxwV.png alt></p><p>Then create a CloudFront distribution. Connect its orgin to your S3 bucket <code>mybucket</code>. Also, enable the CloudFront bucket access restriction and add a new CloudFront origin access identity to your S3 permission policy:</p><p><img src=https://i.imgur.com/e6TDyeC.png alt></p><p>Enable the CloudFront viewer access restriction and connect it to your key group:</p><p><img src=https://i.imgur.com/cNelOe1.png alt></p><p>Check your CloudFront distribution status <a href=https://console.aws.amazon.com/cloudfront/home#distributions:>here</a>. Wait until its status becomes <code>Deployed</code>. Then you will see the domain name of your CloudFront distribution.</p><p>We enabled the CloudFront bucket access restriction so that clients cannot access your object using S3 URL but only CloudFront URLs.</p><p>Whenever your users access your Amazon S3 objects through CloudFront, the CloudFront origin access identity retrieves the objects on behalf of your users. If your users request objects directly by using Amazon S3 URLs, he or she will be denied. The procedure can be summarized in the following figure:</p><p><img src=https://i.imgur.com/uMDqXdz.png alt></p><p>In addition, we restrict viewer access so that only requests through signed URLs are allowed to access your content. The signing mechanism works by hashing and signing one part of the URL using the private key from your public–private key pair. When someone uses a signed URL to access a file, CloudFront compares the signed and unsigned portions of the URL. If they don&rsquo;t match, CloudFront doesn&rsquo;t serve the file.</p><p>If you don&rsquo;t restrict viewer access, all requests through CloudFront URLs are allowed to access your backend S3 objects, ie. they are public to the entire world. So please be sure to enable the viewer access restriction if you want to protect your private contents.</p><h2 id=signed-url-creation-example>Signed URL Creation Example</h2><p>You can see the complete source code example on <a href=https://github.com/minghsu0107/cloudFront-signed-url>my Github</a>.</p><p>In this example, we will use <a href=https://github.com/aws/aws-sdk-go>Golang AWS SDK</a> to upload <code>hello.txt</code> to S3 bucket <code>mybucket</code> with key <code>mysubpath/hello.txt</code>. Then we will create its signed URL, which has a 1 hour expiration. Users can only access your private content <code>hello.txt</code> through this signed URL.</p><p>First, create a new client session:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>creds</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>credentials</span>.<span style=color:#a6e22e>NewStaticCredentials</span>(<span style=color:#a6e22e>accessKey</span>, <span style=color:#a6e22e>secretKey</span>, <span style=color:#e6db74>&#34;&#34;</span>)

<span style=color:#a6e22e>config</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>Config</span>{
    <span style=color:#a6e22e>Credentials</span>: <span style=color:#a6e22e>creds</span>,
    <span style=color:#a6e22e>Region</span>:      <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>s3Region</span>),
    <span style=color:#a6e22e>MaxRetries</span>:  <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>Int</span>(<span style=color:#ae81ff>3</span>),
}
<span style=color:#a6e22e>session</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>NewSession</span>(<span style=color:#a6e22e>config</span>)
</code></pre></div><p>Upload <code>hello.txt</code> to the S3 bucket:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>fromFile</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#a6e22e>uploadFrom</span>)
<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
    <span style=color:#a6e22e>exitErrorf</span>(<span style=color:#e6db74>&#34;Unable to open file %q, %v&#34;</span>, <span style=color:#a6e22e>uploadFrom</span>, <span style=color:#a6e22e>err</span>)
}
<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>fromFile</span>.<span style=color:#a6e22e>Close</span>()

<span style=color:#a6e22e>uploader</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s3manager</span>.<span style=color:#a6e22e>NewUploader</span>(<span style=color:#a6e22e>session</span>)
<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>output</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>s3manager</span>.<span style=color:#a6e22e>UploadOutput</span>
<span style=color:#a6e22e>output</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>uploader</span>.<span style=color:#a6e22e>UploadWithContext</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>s3manager</span>.<span style=color:#a6e22e>UploadInput</span>{
    <span style=color:#a6e22e>Bucket</span>:  <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>s3Bucket</span>),
    <span style=color:#a6e22e>Key</span>:     <span style=color:#a6e22e>aws</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>objKey</span>),
    <span style=color:#a6e22e>Body</span>:    <span style=color:#a6e22e>fromFile</span>,
})
</code></pre></div><p>Sign the CloudFront object URL of <code>hello.txt</code> with the CloudFront public key ID and private key you created previously:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>priKey</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>rsa</span>.<span style=color:#a6e22e>PrivateKey</span>
<span style=color:#a6e22e>priKey</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>sign</span>.<span style=color:#a6e22e>LoadPEMPrivKey</span>(<span style=color:#a6e22e>priKeyFile</span>)
<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
    <span style=color:#a6e22e>exitErrorf</span>(<span style=color:#e6db74>&#34;err loading private key, %v&#34;</span>, <span style=color:#a6e22e>err</span>)
}

<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>signedURL</span> <span style=color:#66d9ef>string</span>
<span style=color:#a6e22e>signer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sign</span>.<span style=color:#a6e22e>NewURLSigner</span>(<span style=color:#a6e22e>cfAccessKey</span>, <span style=color:#a6e22e>priKey</span>)

<span style=color:#a6e22e>rawURL</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>URL</span>{
    <span style=color:#a6e22e>Scheme</span>: <span style=color:#e6db74>&#34;https&#34;</span>,
    <span style=color:#a6e22e>Host</span>:   <span style=color:#a6e22e>cfDomain</span>,
    <span style=color:#a6e22e>Path</span>:   <span style=color:#a6e22e>objKey</span>,
}
<span style=color:#a6e22e>signedURL</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>signer</span>.<span style=color:#a6e22e>Sign</span>(<span style=color:#a6e22e>rawURL</span>.<span style=color:#a6e22e>String</span>(), <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>1</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Hour</span>))
<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
    <span style=color:#a6e22e>exitErrorf</span>(<span style=color:#e6db74>&#34;Failed to sign url, err: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
}
<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Get signed URL %q\n&#34;</span>, <span style=color:#a6e22e>signedURL</span>)
</code></pre></div><p>The CloudFront object URL <code>https://mycfdomain.cloudfront.net/mysubpath/hello.txt</code> is now signed, and th result is printed in the standard output. Users can access <code>hello.txt</code> through this signed URL until it expires.</p><h2 id=reference>Reference</h2><ul><li><a href=https://medium.com/@ratulbasak93/serving-private-content-of-s3-through-cloudfront-signed-url-593ede788d0d>https://medium.com/@ratulbasak93/serving-private-content-of-s3-through-cloudfront-signed-url-593ede788d0d</a></li></ul></div><h2>Recommended Articles</h2><ul><li><a href=https://minghsu0107.github.io/posts/deploy-docker-containers-on-ecs/>[AWS] Deploy Docker Containers on ECS</a></li><li><a href=https://minghsu0107.github.io/posts/event-driven-golang-taipei-55/>輕鬆「Go」建事件驅動應用</a></li><li><a href=https://minghsu0107.github.io/posts/http-context/>Passing Parameters in Golang HTTP Context</a></li><li><a href=https://minghsu0107.github.io/posts/first-post/>我如何架設這部落格的？</a></li></ul><h2>Comments</h2><script src=https://utteranc.es/client.js repo=minghsu0107/blog issue-term=pathname theme=github-light crossorigin=anonymous async></script></main></body></html>
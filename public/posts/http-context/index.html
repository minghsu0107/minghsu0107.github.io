<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link rel=stylesheet href=https://unpkg.com/spectre.css/dist/spectre.min.css><link rel=stylesheet href=https://unpkg.com/spectre.css/dist/spectre-exp.min.css><link rel=stylesheet href=https://unpkg.com/spectre.css/dist/spectre-icons.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/nnfx-dark.min.css><link rel=stylesheet href=https://pro.fontawesome.com/releases/v5.10.0/css/all.css integrity=sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p crossorigin=anonymous><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.81.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Passing Parameters in Golang HTTP Context &#183; Ming's Site</title><meta name=description content><link type=text/css rel=stylesheet href=https://minghsu0107.github.io/css/print.css media=print><link type=text/css rel=stylesheet href=https://minghsu0107.github.io/css/poole.css><link type=text/css rel=stylesheet href=https://minghsu0107.github.io/css/syntax.css><link type=text/css rel=stylesheet href=https://minghsu0107.github.io/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><style>pre,code{white-space:pre;overflow-x:scroll}.hljs{display:inline-block;overflow-x:scroll;padding-right:100%;background:0 0;color:#fff;-webkit-text-size-adjust:none;min-width:2300px}</style><style>@import "https://fonts.googleapis.com/css?family=Open+Sans";body{font-family:open sans,sans-serif}.searchTerm{border-radius:5px;width:100%;border:1px solid #00b4cc;padding:5px}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-96ZZVQWZLF"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-96ZZVQWZLF')</script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/languages/yaml.min.js></script><script>hljs.initHighlightingOnLoad()</script><body><aside class=sidebar><div class=container><div class=sidebar-about><a href=https://minghsu0107.github.io/><h1>Ming's Site</h1></a><p class=lead><a href=https://github.com/minghsu0107><i class="fab fa-github"></i></a>&nbsp;&nbsp;<a href=https://linkedin.com/in/hao-ming-hsu-178176181> <i class="fab fa-linkedin"></i></a><br><a href=/about>Hao-Ming Hsu (許浩鳴)</a><br>Learn by Doing.<br><a href=https://github.com/minghsu0107>@minghsu0107</a></p></div><nav><ul class=sidebar-nav><li><a href=/about>About</a></li><li><a href=/categories>Categories</a></li><li><a href=/tags>Tags</a></li></ul></nav><div style="margin:0 auto"><form action=https://minghsu0107.github.io/search><input placeholder=search class=searchTerm id=search-query name=s></form></div><br><p>&copy; 2021. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>Passing Parameters in Golang HTTP Context</h1><time datetime=2021-03-01T20:44:13+0800 class=post-date>Mon, Mar 1, 2021 &#183; <span class=read-time>1 min read</span></time><p>When developing HTTP APIs, we may have to process the same request-specific data throughout middlewares. Since it&rsquo;s a quite common pattern, I decide to figure it out and share how I solve it.</p><h2 id=example>Example</h2><p>Here we are using <a href=https://github.com/gin-gonic/gin>Gin</a>, a web framework written in golang featuring performance and good productivity.</p><p>Suppose we have an api endpoint <code>/api/hello</code> handled by <code>HelloHandleFunc</code>. For each incoming request, we want to authenticate its JWT (in <code>Authentication</code> header) and pass the decoded user ID to <code>HelloHandleFunc</code>. <a href=https://jwt.io>This website</a> clearly illustrates what JWT is.</p><p>The main idea is to make use of <code>context.Context</code> in <code>http.Request</code>. The context of each request controls the entire request life cycle. Thus, we can set request-specific data (key-value pairs) in the context using <code>context.WithValue()</code> and retrives it using <code>Context.Value()</code>.</p><p>The following code shows the implementation of <code>AddUserID()</code> middleware, which summarizes the above procedure:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>extractToken</span>(<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) <span style=color:#66d9ef>string</span> {
	<span style=color:#a6e22e>bearToken</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>conf</span>.<span style=color:#a6e22e>JWTAuthHeader</span>)
	<span style=color:#a6e22e>strArr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>bearToken</span>, <span style=color:#e6db74>&#34; &#34;</span>)
	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>strArr</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>strArr</span>[<span style=color:#ae81ff>1</span>]
	}
	<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>
}
<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>AddUserID</span>() <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>HandlerFunc</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
        <span style=color:#a6e22e>accessToken</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>extractToken</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>)
        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>accessToken</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
		    <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>AbortWithStatus</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusUnauthorized</span>)
			<span style=color:#66d9ef>return</span>
		}
        <span style=color:#a6e22e>userID</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>DecodeJWT</span>(<span style=color:#a6e22e>accessToken</span>)
		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>WithContext</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithValue</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Context</span>(), <span style=color:#e6db74>&#34;user_id&#34;</span>, <span style=color:#a6e22e>userID</span>))
		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Next</span>()
	}
}
</code></pre></div><p>Retrieve <code>user_id</code> from the context in <code>HelloHandleFunc</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>HelloHandleFunc</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
	<span style=color:#a6e22e>customerID</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Context</span>().<span style=color:#a6e22e>Value</span>(<span style=color:#e6db74>&#34;user_id&#34;</span>).(<span style=color:#66d9ef>string</span>)
	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Abort</span>()
		<span style=color:#66d9ef>return</span>
	}
	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;hi, %s!&#34;</span>, <span style=color:#a6e22e>customerID</span>))
	<span style=color:#66d9ef>return</span>
}
</code></pre></div><p>Register the route with <code>AddUserID()</code> middleware enabled:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>router</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>New</span>()
<span style=color:#a6e22e>group</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>Group</span>(<span style=color:#e6db74>&#34;/api/hello&#34;</span>)
<span style=color:#a6e22e>group</span>.<span style=color:#a6e22e>Use</span>(<span style=color:#a6e22e>AddUserID</span>())
<span style=color:#a6e22e>group</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/hello&#34;</span>, <span style=color:#a6e22e>HelloHandleFunc</span>)
</code></pre></div><p>Start the server:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#e6db74>&#34;:8080&#34;</span>)
</code></pre></div></div><h2>Comments</h2><script src=https://utteranc.es/client.js repo=minghsu0107/blog issue-term=pathname theme=github-light crossorigin=anonymous async></script></main></body></html>